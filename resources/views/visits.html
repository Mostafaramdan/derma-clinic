<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <title>شاشة الزيارة — تصميم جمالي (نسخة محدثة)</title>
  <style>
    :root{
      --bg:#f9fafc; --surface:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --primary:#2563eb; --success:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --radius-xl:18px; --radius-lg:14px; --radius:12px; --pad:16px;
      --chip:#f1f5f9; --shadow: 0 8px 24px rgba(37,99,235,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f8fafc,#f4f6fa);color:var(--text);font:15.5px/1.7 'Cairo',system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .container{max-width:1200px;margin:0 auto;padding:20px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px) saturate(140%);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
    .topbar-inner{display:flex;justify-content:space-between;align-items:center;padding:12px 20px}
    .brand{display:flex;align-items:center;gap:12px}
    .avatar{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:800;box-shadow:0 4px 10px rgba(37,99,235,.25)}
    .actions{display:flex;gap:10px}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:var(--radius);padding:10px 14px;font-weight:800;background:#ffffff;color:#0f172a;border:1px solid #e2e8f0;box-shadow:0 6px 14px rgba(15,23,42,.06);transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(15,23,42,.1)}
    .btn.primary{background:linear-gradient(135deg,#3b82f6,#2563eb);border:0;color:#fff;box-shadow:0 8px 18px rgba(37,99,235,.25)}

    /* Tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;border-bottom:1px solid transparent;padding-bottom:8px}
    .tab-btn{background:#ffffff;border:1px solid var(--line);color:var(--muted);padding:10px 16px;border-radius:14px;cursor:pointer;box-shadow:0 6px 14px rgba(15,23,42,.06);transition:transform .15s ease, box-shadow .15s ease, color .2s ease}
    .tab-btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(15,23,42,.1);color:#0f172a}
    .tab-btn[aria-selected="true"]{color:#0f172a;background:#eef4ff;border:1px solid #c7d2fe;box-shadow:0 8px 18px rgba(37,99,235,.12)}
    .tabpanels{padding-top:16px}
    .tabpanel{display:none}
    .tabpanel[aria-hidden="false"]{display:block;animation:fadeIn .35s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    /* Cards */
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius-xl);box-shadow:var(--shadow);overflow:hidden}
    .card .head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(90deg,#f8fafc,#f1f5f9);border-bottom:1px solid var(--line)}
    .card .head h3{margin:0;font-size:1rem;color:var(--primary);position:relative;padding-inline-start:12px}
    .card .head h3::before{content:"";position:absolute;inset-inline-start:0;top:6px;width:6px;height:18px;border-radius:6px;background:linear-gradient(180deg,#60a5fa,#2563eb)}
    .card .body{padding:18px}

    /* Layout */
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width: 1080px){.grid{grid-template-columns:1fr}}

    /* Form */
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-bottom:12px}
    .field{display:flex;flex-direction:column;gap:6px;grid-column:span 6}
    .field.third{grid-column:span 4}
    .field.quarter{grid-column:span 3}
    .field.full{grid-column:1/-1}
    label{color:#0f172a;font-weight:800;font-size:13.5px;letter-spacing:.1px}
    input,select,textarea{width:100%;padding:12px;border-radius:14px;background:#fff;border:1px solid #d1d9e6;color:#0f172a;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.6), 0 0 0 rgba(0,0,0,0);transition:border-color .2s, box-shadow .2s}
    textarea{min-height:96px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 4px rgba(37,99,235,.12), inset 0 1px 0 rgba(255,255,255,.6)}

    /* Chips */
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #e2e8f0;color:#0f172a;border-radius:999px;padding:6px 12px;font-size:13px;font-weight:700}
    .hint{color:var(--muted);font-size:13px}

    /* Uploader */
    .uploader{border:2px dashed #cbd5e1;border-radius:14px;padding:20px;background:#f9fafc;text-align:center;color:#64748b;transition:.3s}
    .uploader:hover{background:#f1f5f9;color:#334155}

    /* Table */
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #e2e8f0;padding:10px;text-align:right}
    th{color:#334155;background:#f9fafc;font-weight:800}

    /* Totals */
    .totals{display:grid;gap:8px;border-top:1px dashed var(--line);padding-top:12px;margin-top:8px}
    .totals .line{display:flex;justify-content:space-between}
    .grand{font-size:18px;font-weight:800;color:var(--primary)}

    /* Skin type cards */
    .skin-types{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .skin-card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px;border:2px solid #e2e8f0;border-radius:14px;background:#fff;cursor:pointer;transition:.2s}
    .skin-card:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.06)}
    .skin-card.active{border-color:#2563eb;background:#eff6ff;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .skin-chip{font-weight:800;color:#0f172a}

    /* Anim */
    .svc-item,.lab-item{transition:transform .2s,box-shadow .2s}
    .svc-item:hover,.lab-item:hover{transform:translateY(-2px);box-shadow:0 4px 14px rgba(0,0,0,.05)}

    @media print{.no-print{display:none!important} body{background:#fff;color:#000} .card{box-shadow:none}}
    /* Enhanced Skin Types visuals */
    .skin-types{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .skin-card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;border:2px solid #e2e8f0;border-radius:16px;background:#fff;cursor:pointer;transition:.22s;box-shadow:0 6px 14px rgba(15,23,42,.06)}
    .skin-card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(15,23,42,.1)}
    .skin-card.active{border-color:#2563eb;box-shadow:0 0 0 4px rgba(37,99,235,.14), 0 12px 26px rgba(15,23,42,.12)}
    .skin-swatch{width:40px;height:40px;border-radius:999px;box-shadow:inset 0 2px 0 rgba(255,255,255,.75);border:1px solid #e2e8f0}
    .skin-label{font-weight:900;letter-spacing:.3px;color:#0f172a}
    .st1{background:#fdebd4}
    .st2{background:#f6d6b5}
    .st3{background:#e6be9a}
    .st4{background:#c48d62}
    .st5{background:#9b6946}
    .st6{background:#5b3c2d}
    @keyframes pop{0%{transform:scale(0.95)}60%{transform:scale(1.03)}100%{transform:scale(1)}}
    .skin-card.active .skin-swatch{animation:pop .3s ease}
  /* Fitz banner */
    .fitz-banner{display:flex;justify-content:center;margin:8px 0 14px}
    .fitz-banner img{max-width:100%;height:auto;border-radius:12px;border:1px solid var(--line);box-shadow:0 6px 14px rgba(15,23,42,.06)}
  /* Tooltips & type-colored active states */
    .skin-card{position:relative}
    .skin-card:hover::after{content:attr(data-tip);position:absolute;bottom:-30px;right:50%;transform:translateX(50%);background:#334155;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;white-space:nowrap;box-shadow:0 6px 14px rgba(15,23,42,.12)}
    .skin-card[data-value="I"].active{background:#fdebd4}
    .skin-card[data-value="II"].active{background:#f6d6b5}
    .skin-card[data-value="III"].active{background:#e6be9a}
    .skin-card[data-value="IV"].active{background:#c48d62;color:#fff}
    .skin-card[data-value="V"].active{background:#9b6946;color:#fff}
    .skin-card[data-value="VI"].active{background:#5b3c2d;color:#fff}
  /* Fitz banner */
    .fitz-banner{display:flex;justify-content:center;margin:8px 0 14px}
    .fitz-banner img{max-width:100%;height:auto;border-radius:12px;border:1px solid var(--line);box-shadow:0 6px 14px rgba(15,23,42,.06)}

    /* Active coloring */
    .skin-card[data-value="I"].active{background:#fdebd4}
    .skin-card[data-value="II"].active{background:#f6d6b5}
    .skin-card[data-value="III"].active{background:#e6be9a}
    .skin-card[data-value="IV"].active{background:#c48d62;color:#fff}
    .skin-card[data-value="V"].active{background:#9b6946;color:#fff}
    .skin-card[data-value="VI"].active{background:#5b3c2d;color:#fff}

    /* Tooltip */
    .skin-card{position:relative}
    .skin-card:hover::after{
      content:attr(data-tip);
      position:absolute;bottom:-32px;right:50%;transform:translateX(50%);
      background:#334155;color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;white-space:nowrap;box-shadow:0 4px 10px rgba(0,0,0,.2)
    }
  /* Multi chips (body locations) */
    .multi-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip.selectable{cursor:pointer;user-select:none;transition:.18s}
    .chip.selectable:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(15,23,42,.08)}
    .chip.selectable.active{background:#e0f2fe;border-color:#93c5fd;color:#0c4a6e;box-shadow:0 0 0 3px rgba(59,130,246,.18)}

  /* Smaller skin swatches */
    .skin-swatch{width:32px;height:32px;border-radius:999px;box-shadow:inset 0 2px 0 rgba(255,255,255,.75);border:1px solid #e2e8f0}
  /* Body map */
    .bodymap-controls{display:flex;gap:8px;margin:6px 0}
    .bm-toggle.active{outline:2px solid #93c5fd}
    .bodymap{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center;justify-items:center;background:#f8fafc;border:1px solid var(--line);border-radius:14px;padding:10px}
    .figure{width:100%;max-width:320px}
    .figure .area{fill:rgba(37,99,235,.08);stroke:#334155;stroke-width:1.5;opacity:.6;transition:.18s;cursor:pointer}
    .figure .area:hover{opacity:1}
    .figure .area.active{fill:rgba(37,99,235,.22);opacity:1;filter:drop-shadow(0 4px 8px rgba(37,99,235,.18))}
    .figure .area.active circle,.figure .area.active rect{animation:bm-pop .28s ease}
    @keyframes bm-pop{0%{transform:scale(.96)}60%{transform:scale(1.04)}100%{transform:scale(1)}}
    @media (max-width:900px){.bodymap{grid-template-columns:1fr}}
/* BodyPicker (image + hotspots) */
    .bodypicker{
        position:relative;width:100%;aspect-ratio:3/5.6;
        border:1px solid var(--line);border-radius:14px;
        background:#EAF4FF;overflow:hidden
        }
    .bodypicker .bp-canvas{position:absolute;inset:0;background-size:contain;background-repeat:no-repeat;background-position:center;filter:drop-shadow(0 6px 14px rgba(15,23,42,.06))}
    .bodypicker[data-view="front"] .bp-canvas{background-image:url('https://api.cefour.com/storage/image/human-anatomy-hand-drawn-vector-illustrations-set-male-body_(2)_(1)_68bb9c86797bc.jpg')}
    .bodypicker[data-view="back"]  .bp-canvas{background-image:url('https://api.cefour.com/storage/image/human-anatomy-hand-drawn-vector-illustrations-set-male-body_(2)_(1)_68bb9c86797bc.jpg')}
    .bodypicker-controls{display:flex;gap:8px;margin:6px 0}
    .bp-toggle.active{outline:2px solid #93c5fd}
    .bp-spot{position:absolute;transform:translate(-50%,-50%);width:34px;height:34px;border-radius:50%;background:rgba(37,99,235,.08);border:2px solid rgba(37,99,235,.35);cursor:pointer;display:grid;place-items:center;transition:transform .15s, box-shadow .15s, background .15s, border-color .15s}
    .bp-spot::after{content:"";width:14px;height:14px;border-radius:50%;background:rgba(37,99,235,.45)}
    .bp-spot:hover{transform:translate(-50%,-50%) scale(1.06);box-shadow:0 8px 18px rgba(37,99,235,.18)}
    .bp-spot.active{background:rgba(37,99,235,.28);border-color:#2563eb}
    .bp-spot.active::after{background:#2563eb}
    .bp-spot[data-tip]:hover::before{content:attr(data-tip);position:absolute;top:-10px;transform:translate(-50%,-100%);background:#334155;color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;white-space:nowrap}

</style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner container">
      <div class="brand"><div class="avatar">د</div><div><div style="font-weight:900">شاشة الزيارة — دكتور جلدية</div><small style="color:var(--muted)">المريض: فاطمة حسن • اليوم 14:30 • د. أحمد</small></div></div>
      <div class="actions no-print">
        <button class="btn">حفظ مسودة</button>
        <button class="btn primary">حفظ الزيارة</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Visit Tabs">
      <button class="tab-btn" role="tab" id="tab-basic" aria-controls="panel-basic" aria-selected="true">البيانات الأساسية</button>
      <button class="tab-btn" role="tab" id="tab-dx" aria-controls="panel-dx" aria-selected="false">الكشف</button>
      <button class="tab-btn" role="tab" id="tab-rxadv" aria-controls="panel-rxadv" aria-selected="false">الروشتة والإرشادات</button>
      <button class="tab-btn" role="tab" id="tab-labs" aria-controls="panel-labs" aria-selected="false">التحاليل والملفات</button>
      <button class="tab-btn" role="tab" id="tab-photos" aria-controls="panel-photos" aria-selected="false">صور الحالة</button>
      <button class="tab-btn" role="tab" id="tab-billing" aria-controls="panel-billing" aria-selected="false">الخدمات والفوترة</button>
    </div>

    <div class="tabpanels">
      <!-- البيانات الأساسية -->
      <section id="panel-basic" class="tabpanel" role="tabpanel" aria-labelledby="tab-basic" aria-hidden="false">
        <div class="grid">
          <div class="card">
            <div class="head"><h3>🧑 البيانات الأساسية</h3><span class="chip">ملف #P-10234</span></div>
            <div class="body">
              <div class="row">
                <div class="field third"><label>الاسم</label><input value="فاطمة حسن"></div>
                <div class="field quarter"><label>العمر — سنوات</label><input type="number" min="0" max="150" value="28"></div>
                <div class="field quarter"><label>العمر — شهور</label><input type="number" min="0" max="11" value="0"></div>
                <div class="field quarter"><label>النوع</label><select><option>أنثى</option><option>ذكر</option></select></div>
                <div class="field quarter"><label>الحالة الاجتماعية</label><select><option>أعزب/عزباء</option><option>متزوج/ة</option><option>أخرى</option></select></div>
                <div class="field third"><label>المهنة</label><input placeholder="مثال: مُدرّسة"></div>
                <div class="field third"><label>العنوان</label><input placeholder="القاهرة، المهندسين…"></div>
                <div class="field third"><label>رقم التليفون</label><input type="tel" placeholder="01xxxxxxxxx"></div>
                <div class="field full"><label>ملاحظات أخرى</label><input placeholder="أي ملاحظات إضافية…"></div>
              </div>
            </div>
          </div>

          <aside class="card">
            <div class="head"><h3>⚕️ التاريخ المرضي</h3></div>
            <div class="body">
              <div class="row">
                <div class="field quarter"><label>سكر</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>ضغط</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>حساسية أدوية</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>حمل</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>رضاعة</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field full"><label>أمراض أخرى</label><input placeholder="مثال: ربو، قلب…"></div>
                              <div class="field full"><label>ملاحظات أخرى</label><input placeholder="تفاصيل إضافية…"></div>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- الكشف والروشتة -->
      <section id="panel-dx" class="tabpanel" role="tabpanel" aria-labelledby="tab-dx" aria-hidden="true">
        <div class="card">
          <div class="head"><h3>🩺 الكشف</h3></div>
          <div class="body">
            <!-- First: fields moved here per request -->
            <div class="row">
              <div class="field full">
                <label>نوع البشرة (Fitzpatrick)</label>

                <div class="skin-types" id="skinTypes">
                  <div class="skin-card" data-value="I" data-tip="Type I: بشرة فاتحة جدًا، تحترق دائمًا، لا تسمر">
                    <div class="skin-swatch st1"></div>
                    <div class="skin-label">Type I</div>
                  </div>
                  <div class="skin-card" data-value="II" data-tip="Type II: فاتحة، غالبًا تحترق، قد تسمر قليلًا">
                    <div class="skin-swatch st2"></div>
                    <div class="skin-label">Type II</div>
                  </div>
                  <div class="skin-card" data-value="III" data-tip="Type III: متوسطة، أحيانًا تحترق، تسمر تدريجيًا">
                    <div class="skin-swatch st3"></div>
                    <div class="skin-label">Type III</div>
                  </div>
                  <div class="skin-card" data-value="IV" data-tip="Type IV: قمحية، نادرًا ما تحترق، تسمر بسهولة">
                    <div class="skin-swatch st4"></div>
                    <div class="skin-label">Type IV</div>
                  </div>
                  <div class="skin-card" data-value="V" data-tip="Type V: داكنة، نادرًا جدًا تحترق، تسمر بوضوح">
                    <div class="skin-swatch st5"></div>
                    <div class="skin-label">Type V</div>
                  </div>
                  <div class="skin-card" data-value="VI" data-tip="Type VI: داكنة جدًا، لا تحترق تقريبًا، تسمر قوي">
                    <div class="skin-swatch st6"></div>
                    <div class="skin-label">Type VI</div>
                  </div>
                </div>
                <input type="hidden" id="skinTypeInput" name="skin_type">
              </div>
              <div class="field third"><label>شكوى رئيسية</label><input placeholder="حب شباب — حبوب تحت الجلد"></div>
              <div class="field third"><label>شدة الأعراض</label>
                <select>
                  <option value="1">1 — بسيط</option>
                  <option value="2">2 — متوسط</option>
                  <option value="3">3 — شديد</option>
                  <option value="4">4 — عنيف جدًا</option>
                </select>
              </div>
              <div class="field third"><label>المدة</label>
                <select>
                  <option>أقل من شهر</option>
                  <option>من 1–3 شهور</option>
                  <option>من 3–6 شهور</option>
                  <option>من 6–12 شهر</option>
                  <option>أكثر من سنة</option>
                </select>
              </div>
            </div>

            <!-- Body locations (multi-select) -->
            <div class="row">
              <div class="field full">
                <label>المكان</label>
                <div class="bodypicker-controls">
                  <button type="button" class="btn bp-toggle active" data-view="front">منظر أمامي</button>
                  <button type="button" class="btn bp-toggle" data-view="back">منظر خلفي</button>
                </div>
                <div id="BodyPicker" class="bodypicker" data-view="front" aria-label="خريطة جسم">
                  <div class="bp-canvas"></div>
                </div>
                <input type="hidden" id="locationsInput" name="locations">
                <div class="hint" style="margin-top:8px">اختيار متعدد: اضغط على أكثر من موضع. بدّل بين الأمامي/الخلفي من الأزرار.</div>
              </div>
            </div>

            <div class="row">
              <div class="field third"><label>بداية المرض (Onset)</label><input placeholder="مثال: منذ 6 أشهر"></div>
              <div class="field third"><label>مسار المرض (Course)</label><select><option>مستمر</option><option>متردد/ينتكس</option><option>متحسن</option><option>متفاقم</option></select></div>
              <div class="field third"><label>التشخيص</label><input placeholder="Acne vulgaris — Grade 2"></div>
              <div class="field third"><label>ملاحظات التشخيص</label><input placeholder="PIH، ندبات سطحية…"></div>
              <div class="field third"><label>موعد المتابعة</label><input type="date"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- الروشتة (تبويب مستقل) -->
      <!-- الروشتة والإرشادات (تبويب موحّد) -->
      <section id="panel-rxadv" class="tabpanel" role="tabpanel" aria-labelledby="tab-rxadv" aria-hidden="true">
        <div class="card">
          <div class="head"><h3>💊 الروشتة & 💡 الإرشادات</h3></div>
          <div class="body">
            <!-- قوالب الروشتة -->
            <div class="row">
              <div class="field third"><label>قالب روشتة</label>
                <select id="rxTemplate">
                  <option value="">— اختر قالبًا —</option>
                  <option value="acne_mild">Acne — Mild</option>
                  <option value="acne_moderate">Acne — Moderate</option>
                  <option value="pih">Post‑Inflammatory Hyperpigmentation</option>
                </select>
              </div>
              <div class="field quarter"><label>&nbsp;</label><button class="btn" id="btnInsertTemplate">إدراج القالب</button></div>
            </div>

            <!-- جدول الروشتة (LTR والدواء على الشمال) -->
            <div class="table-wrap" style="margin-top:8px">
              <table style="direction:ltr">
                <thead>
                  <tr>
                    <th style="text-align:left">الدواء</th>
                    <th style="text-align:left">التركيز</th>
                    <th style="text-align:left">الجرعة</th>
                    <th style="text-align:left">التكرار</th>
                    <th style="text-align:left">المدّة (أيام)</th>
                    <th style="text-align:left">تعليمات</th>
                  </tr>
                </thead>
                <tbody id="rxTableBody">
                  <tr>
                    <td><input placeholder="Adapalene gel"></td>
                    <td><input placeholder="0.1%"></td>
                    <td><input placeholder="طبقة رقيقة"></td>
                    <td><input placeholder="مساءً"></td>
                    <td><input type="number" value="30"></td>
                    <td><input placeholder="Patch test أولًا"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- تفعيل الإرشادات + قوالبها -->
            <div class="row" style="margin-top:14px">
              <div class="field quarter"><label>تفعيل الإرشادات</label>
                <label style="display:flex;align-items:center;gap:8px"><input id="adviceToggle" type="checkbox"> <span>تشغيل الإرشادات</span></label>
              </div>
              <div class="field third"><label>قالب إرشادات</label>
                <select id="adviceTemplate" disabled>
                  <option value="">— اختر قالبًا —</option>
                  <option value="acne_care">Basic Acne Care</option>
                  <option value="laser_post">Laser Post‑Care</option>
                  <option value="peel_after">Peel After‑Care</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="field full" id="adviceChipsWrap" aria-disabled="true">
                <div class="chip">تجنّب الشمس المباشر</div>
                <div class="chip">SPF ≥ 50</div>
                <div class="chip">مرطّب صباحًا/مساءً</div>
                <div class="chip">منظّف لطيف</div>
              </div>
              <div class="field full"><label>تعليمات إضافية</label><textarea id="adviceText" placeholder="تعليمات إضافية للطبيب…" disabled></textarea></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Labs & Files -->
      <section id="panel-labs" class="tabpanel" role="tabpanel" aria-labelledby="tab-labs" aria-hidden="true">
        <div class="grid">
          <div class="card">
            <div class="head"><h3>🧪 التحاليل (مكرر قابل للإضافة)</h3></div>
            <div class="body">
              <div class="uploader">اسحب ملف نتيجة (PDF/صورة) أو اضغط للاختيار</div>
              <div style="margin-top:12px">
                <label>تحاليل هذه الزيارة</label>
                <div id="labRepeater">
                  <div class="lab-item" style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px;background:#fff">
                    <div class="row">
                      <div class="field third"><label>اسم التحليل</label><input placeholder="CBC / LFTs / …"></div>
                      <div class="field third"><label>ملاحظات</label><input placeholder="صيام، وقت، إلخ"></div>
                      <div class="field third"><label>رفع النتيجة</label><input type="file"></div>
                      <div class="field third"><label>بيان المعمل</label><input value="المعمل : القصر العيني"></div>
                      <div class="field quarter"><label>&nbsp;</label><button class="btn lab-remove" style="width:100%">حذف</button></div>
                    </div>
                  </div>
                </div>
                <button id="addLab" class="btn" style="margin-top:8px">+ إضافة تحليل</button>
              </div>
            </div>
          </div>

          <aside class="card">
            <div class="head"><h3>📎 ملفات محفوظة</h3></div>
            <div class="body">
              <table>
                <thead><tr><th>الملف</th><th>النوع</th><th>التاريخ</th><th>إجراء</th></tr></thead>
                <tbody>
                  <tr><td>CBC-Result-2025-09-02.pdf</td><td>PDF</td><td>02-09-2025</td><td><button class="btn">عرض</button></td></tr>
                  <tr><td>lesion-closeup-1.jpg</td><td>صورة</td><td>02-09-2025</td><td><button class="btn">عرض</button></td></tr>
                </tbody>
              </table>
            </div>
          </aside>
        </div>
      </section>

      <!-- Photos -->
      <section id="panel-photos" class="tabpanel" role="tabpanel" aria-labelledby="tab-photos" aria-hidden="true">
        <div class="card">
          <div class="head"><h3>📸 صور الحالة</h3></div>
          <div class="body">
            <div class="hint" style="margin-bottom:8px">الرجاء الحصول على موافقة تصوير واضحة من المريض.</div>
            <div class="row">
              <div class="field full"><label>ملاحظات على الصور</label><input placeholder="مسافة 50سم، إضاءة موحّدة، زاوية أمامية/جانبية"></div>
              <div class="field third"><div class="uploader">إضافة صورة</div></div>
              <div class="field third"><div class="uploader">إضافة صورة</div></div>
              <div class="field third"><div class="uploader">إضافة صورة</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Billing -->
      <section id="panel-billing" class="tabpanel" role="tabpanel" aria-labelledby="tab-billing" aria-hidden="true">
        <div class="grid">
          <div class="card">
            <div class="head"><h3>💳 الخدمات والإجراءات</h3></div>
            <div class="body">
              <div class="hint">يمكن تعديل السعر يدويًا لكل خدمة.</div>
              <div id="svcRepeater">
                <div class="svc-item" style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px;background:#fff">
                  <div class="row">
                    <div class="field third"><label>الخدمة</label>
                      <select class="svc-select">
                        <option value="consult" data-price="300">كشف جلدية</option>
                        <option value="laser_small" data-price="500">جلسة ليزر (منطقة صغيرة)</option>
                        <option value="peel_light" data-price="400">تقشير كيميائي خفيف</option>
                        <option value="dermapen" data-price="600">Dermapen</option>
                        <option value="other" data-price="0">خدمة أخرى…</option>
                      </select>
                    </div>
                    <div class="field quarter"><label>السعر (جنيه)</label><input class="svc-price" type="number" value="300" min="0" step="1"></div>
                    <div class="field quarter"><label>الكمية</label><input class="svc-qty" type="number" value="1" min="1" step="1"></div>
                    <div class="field quarter"><label>إجمالي البند</label><div class="chip"><strong class="line-total">EGP 300.00</strong></div></div>
                    <div class="field quarter"><label>&nbsp;</label><button class="btn svc-remove" style="width:100%">حذف</button></div>
                  </div>
                </div>
              </div>
              <button id="addSvc" class="btn" style="margin-top:8px">+ إضافة خدمة</button>
            </div>
          </div>

          <aside class="card">
            <div class="head"><h3>🧾 الملخص المالي</h3></div>
            <div class="body">
              <div class="row">
                <div class="field third"><label>طريقة الدفع</label><select><option>نقدي</option><option>بطاقة</option><option>تحويل</option></select></div>
                <div class="field third"><label>سبب الخصم</label><input id="discReason" placeholder="عرض/كوبون/ولاء"></div>
                <div class="field quarter"><label>قيمة الخصم</label><input id="discInput" type="number" value="0" min="0" step="1"></div>
                <div class="field quarter"><label>ضريبة/رسوم</label><input id="taxInput" type="number" value="0" min="0" step="1"></div>
              </div>
              <div class="totals">
                <div class="line"><span>المجموع</span><strong id="subtotalVal">EGP 0.00</strong></div>
                <div class="line"><span>خصم</span><strong id="discountVal">EGP 0.00</strong></div>
                <div class="line"><span>ضريبة</span><strong id="taxVal">EGP 0.00</strong></div>
                <div class="line grand"><span>الإجمالي</span><span id="totalVal">EGP 0.00</span></div>
              </div>
              <div class="row" style="margin-top:12px">
                <div class="field third"><button class="btn">إصدار فاتورة</button></div>
                <div class="field third"><button class="btn primary">تحصيل الآن</button></div>
              </div>
            </div>
          </aside>
        </div>
      </section>

    </div>

    <div class="actions no-print" style="justify-content:flex-end;margin-top:16px">
      <button class="btn">حفظ مسودة</button>
      <button class="btn primary">حفظ الزيارة</button>
    </div>
  </main>

<script>
  // Tabs
  const tabs = document.querySelectorAll('[role="tab"]');
  const panels = document.querySelectorAll('[role="tabpanel"]');
  function activateTab(tab){
    tabs.forEach(t=> t.setAttribute('aria-selected','false'));
    panels.forEach(p=> p.setAttribute('aria-hidden','true'));
    tab.setAttribute('aria-selected','true');
    document.getElementById(tab.getAttribute('aria-controls')).setAttribute('aria-hidden','false');
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> activateTab(t)));

  // Skin types selector
  (function(){
    const wrap = document.getElementById('skinTypes');
    const input = document.getElementById('skinTypeInput');
    if(!wrap) return;
    wrap.querySelectorAll('.skin-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        wrap.querySelectorAll('.skin-card').forEach(c=>c.classList.remove('active'));
        card.classList.add('active');
        input.value = card.dataset.value;
      });
    });
  })();

  // BodyPicker (image + hotspots) — تخزين JSON بهويات فريدة
  (function(){
    const picker = document.getElementById('BodyPicker');
    const hidden = document.getElementById('locationsInput');
    if(!picker || !hidden) return;

    // نقاط دقيقة للصورة الحالية (Front/Back)
    const spots = [
      // ===== FRONT – HEAD DETAIL =====
      {id:'front_scalp', key:'رأس علوي امامي', tip:'Scalp', x:23, y:31, view:'front'},
      {id:'front_forehead', key:'جبين', tip:'Forehead', x:23, y:33.1, view:'front'},
      {id:'front_cheek_r', key:'خد يمين', tip:'Right Cheek', x:20, y:37, view:'front'},
      {id:'front_cheek_l', key:'خد يسار', tip:'Left Cheek', x:26, y:37, view:'front'},
      {id:'front_nose', key:'أنف', tip:'Nose', x:50, y:13.4, view:'front'},
      {id:'front_lips', key:'شفاه', tip:'Lips', x:50, y:18.6, view:'front'},
      {id:'front_chin', key:'ذقن', tip:'Chin', x:50, y:21.4, view:'front'},
      {id:'front_ear_r', key:'أذن يمين', tip:'Right Ear', x:39, y:13.2, view:'front'},
      {id:'front_ear_l', key:'أذن يسار', tip:'Left Ear', x:61, y:13.2, view:'front'},

      // ===== FRONT – TORSO =====
      {id:'front_neck', key:'رقبة', x:50, y:23.0, view:'front'},
      {id:'front_shoulder_r', key:'كتف يمين', x:33, y:25.0, view:'front'},
      {id:'front_shoulder_l', key:'كتف يسار', x:67, y:25.0, view:'front'},
      {id:'front_chest', key:'صدر', x:50, y:28.0, view:'front'},
      {id:'front_abdomen', key:'بطن', x:50, y:38.0, view:'front'},
      {id:'front_pelvis', key:'حوض', x:50, y:46.0, view:'front'},

      // ===== FRONT – ARMS & HANDS =====
      {id:'front_upperarm_r', key:'ذراع علوي يمين', x:27.5, y:36.5, view:'front'},
      {id:'front_upperarm_l', key:'ذراع علوي يسار', x:72.5, y:36.5, view:'front'},
      {id:'front_forearm_r', key:'ساعد يمين', x:23.5, y:45.5, view:'front'},
      {id:'front_forearm_l', key:'ساعد يسار', x:76.5, y:45.5, view:'front'},

      {id:'front_palm_r', key:'كف يمين', x:18.5, y:58.5, view:'front'},
      {id:'front_thumb_r', key:'إبهام يمين', x:21.3, y:57.0, view:'front'},
      {id:'front_index_r', key:'سبابة يمين', x:16.6, y:56.8, view:'front'},
      {id:'front_middle_r', key:'وسطى يمين', x:15.8, y:57.6, view:'front'},
      {id:'front_ring_r', key:'بنصر يمين', x:15.1, y:58.8, view:'front'},
      {id:'front_little_r', key:'خنصر يمين', x:15.6, y:60.0, view:'front'},

      {id:'front_palm_l', key:'كف يسار', x:81.5, y:58.5, view:'front'},
      {id:'front_thumb_l', key:'إبهام يسار', x:78.7, y:57.0, view:'front'},
      {id:'front_index_l', key:'سبابة يسار', x:83.4, y:56.8, view:'front'},
      {id:'front_middle_l', key:'وسطى يسار', x:84.2, y:57.6, view:'front'},
      {id:'front_ring_l', key:'بنصر يسار', x:84.9, y:58.8, view:'front'},
      {id:'front_little_l', key:'خنصر يسار', x:84.4, y:60.0, view:'front'},

      // ===== FRONT – LEGS & FEET =====
      {id:'front_thigh_r', key:'فخذ يمين', x:44, y:55.5, view:'front'},
      {id:'front_thigh_l', key:'فخذ يسار', x:56, y:55.5, view:'front'},
      {id:'front_knee_r', key:'ركبة يمين', x:44, y:65.8, view:'front'},
      {id:'front_knee_l', key:'ركبة يسار', x:56, y:65.8, view:'front'},
      {id:'front_leg_r', key:'ساق يمين', x:44, y:76.0, view:'front'},
      {id:'front_leg_l', key:'ساق يسار', x:56, y:76.0, view:'front'},

      {id:'front_heel_r', key:'كعب يمين', x:45, y:90.2, view:'front'},
      {id:'front_dorsum_r', key:'وش القدم يمين', x:45, y:87.2, view:'front'},
      {id:'front_sole_r', key:'أسفل القدم يمين', x:45, y:93.4, view:'front'},
      {id:'front_toes_r', key:'أصابع القدم يمين', x:45, y:95.4, view:'front'},

      {id:'front_heel_l', key:'كعب يسار', x:55, y:90.2, view:'front'},
      {id:'front_dorsum_l', key:'وش القدم يسار', x:55, y:87.2, view:'front'},
      {id:'front_sole_l', key:'أسفل القدم يسار', x:55, y:93.4, view:'front'},
      {id:'front_toes_l', key:'أصابع القدم يسار', x:55, y:95.4, view:'front'},

      // ===== BACK (تقريبية حالياً) =====
      {id:'back_scalp', key:'رأس علوي', x:50, y:6.5, view:'back'},
      {id:'back_neck', key:'رقبة', x:50, y:13.0, view:'back'},
      {id:'back_shoulder_r', key:'كتف يمين', x:33, y:25.0, view:'back'},
      {id:'back_shoulder_l', key:'كتف يسار', x:67, y:25.0, view:'back'},
      {id:'back_upperback', key:'ظهر علوي', x:50, y:28.5, view:'back'},
      {id:'back_lowerback', key:'ظهر سفلي', x:50, y:38.5, view:'back'},
      {id:'back_gluteal', key:'أرداف', x:50, y:46.5, view:'back'},
      {id:'back_upperarm_r', key:'ذراع علوي يمين', x:27.5, y:36.5, view:'back'},
      {id:'back_upperarm_l', key:'ذراع علوي يسار', x:72.5, y:36.5, view:'back'},
      {id:'back_forearm_r', key:'ساعد يمين', x:23.5, y:45.5, view:'back'},
      {id:'back_forearm_l', key:'ساعد يسار', x:76.5, y:45.5, view:'back'},
      {id:'back_palm_r', key:'كف يمين', x:18.5, y:58.5, view:'back'},
      {id:'back_palm_l', key:'كف يسار', x:81.5, y:58.5, view:'back'},
      {id:'back_thigh_r', key:'فخذ يمين', x:44, y:55.5, view:'back'},
      {id:'back_thigh_l', key:'فخذ يسار', x:56, y:55.5, view:'back'},
      {id:'back_knee_r', key:'ركبة يمين', x:44, y:65.8, view:'back'},
      {id:'back_knee_l', key:'ركبة يسار', x:56, y:65.8, view:'back'},
      {id:'back_leg_r', key:'ساق يمين', x:44, y:76.0, view:'back'},
      {id:'back_leg_l', key:'ساق يسار', x:56, y:76.0, view:'back'},
      {id:'back_heel_r', key:'كعب يمين', x:45, y:90.2, view:'back'},
      {id:'back_heel_l', key:'كعب يسار', x:55, y:90.2, view:'back'},
      {id:'back_toes_r', key:'أصابع القدم يمين', x:45, y:95.4, view:'back'},
      {id:'back_toes_l', key:'أصابع القدم يسار', x:55, y:95.4, view:'back'}
    ];

    // بناء الهوت-سبوتس
    const frag = document.createDocumentFragment();
    spots.forEach(s=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'bp-spot';
      b.dataset.id   = s.id;
      b.dataset.key  = s.key;
      b.dataset.view = s.view;
      b.dataset.tip  = s.key;
      b.style.left = s.x + '%';
      b.style.top  = s.y + '%';
      b.hidden = (s.view !== picker.dataset.view);
      b.addEventListener('click', ()=>{ b.classList.toggle('active'); sync(); });
      frag.appendChild(b);
    });
    picker.appendChild(frag);

    // تبديل الأمامي/الخلفي
    document.querySelectorAll('.bp-toggle').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.bp-toggle').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        picker.dataset.view = btn.dataset.view;
        picker.querySelectorAll('.bp-spot').forEach(s=>{
          s.hidden = (s.dataset.view !== picker.dataset.view);
        });
      });
    });

    // مزامنة المدخل المخفي: JSON (id/key/view)
    function sync(){
      const sel = [...picker.querySelectorAll('.bp-spot.active')].map(el=>({
        id: el.dataset.id,
        key: el.dataset.key,
        view: el.dataset.view
      }));
      hidden.value = JSON.stringify(sel);
    }
  })();

  // Labs repeater
  (function(){
    const wrap = document.getElementById('labRepeater');
    const addBtn = document.getElementById('addLab');
    if(!wrap || !addBtn) return;
    addBtn.addEventListener('click', ()=>{
      const first = wrap.querySelector('.lab-item');
      const item = first.cloneNode(true);
      item.querySelectorAll('input').forEach(inp=>{
        if(inp.type==='file'){ try{inp.value=null;}catch(e){} }
        else{
          if(inp.previousElementSibling?.tagName==='LABEL'
             && inp.previousElementSibling.textContent.includes('بيان المعمل')){
            inp.value='المعمل : القصر العيني';
          }else{
            inp.value='';
          }
        }
      });
      wrap.appendChild(item);
    });
    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lab-remove'); if(!btn) return;
      const items = wrap.querySelectorAll('.lab-item');
      if(items.length>1){ btn.closest('.lab-item').remove(); }
    });
  })();

  // Services repeater + totals
  (function(){
    const wrap = document.getElementById('svcRepeater');
    const addBtn = document.getElementById('addSvc');
    const subtotalEl = document.getElementById('subtotalVal');
    const discountEl = document.getElementById('discountVal');
    const taxEl = document.getElementById('taxVal');
    const totalEl = document.getElementById('totalVal');
    const discInput = document.getElementById('discInput');
    const taxInput  = document.getElementById('taxInput');
    const fmt = n => 'EGP ' + (isFinite(n)? Number(n).toFixed(2) : '0.00');

    function recalc(){
      let subtotal = 0;
      wrap.querySelectorAll('.svc-item').forEach(it=>{
        const price = parseFloat(it.querySelector('.svc-price').value||0);
        const qty   = parseInt(it.querySelector('.svc-qty').value||1);
        const line  = (isFinite(price)&&isFinite(qty)) ? price*qty : 0;
        subtotal += line;
        const lineEl = it.querySelector('.line-total'); 
        if(lineEl) lineEl.textContent = fmt(line);
      });
      const discount = parseFloat(discInput?.value||0);
      const tax      = parseFloat(taxInput?.value||0);
      subtotalEl.textContent = fmt(subtotal);
      discountEl.textContent = fmt(discount);
      taxEl.textContent      = fmt(tax);
      totalEl.textContent    = fmt(subtotal - discount + tax);
    }

    function bindItem(it){
      const sel  = it.querySelector('.svc-select');
      const priceInput = it.querySelector('.svc-price');
      const qtyInput   = it.querySelector('.svc-qty');
      sel.addEventListener('change', ()=>{
        const p = parseFloat(sel.selectedOptions[0].getAttribute('data-price')||0);
        priceInput.value = isFinite(p)? p : 0;
        recalc();
      });
      priceInput.addEventListener('input', recalc);
      qtyInput.addEventListener('input', recalc);
      it.querySelector('.svc-remove').addEventListener('click', ()=>{
        const items = wrap.querySelectorAll('.svc-item');
        if(items.length>1){ it.remove(); recalc(); }
      });
    }

    wrap.querySelectorAll('.svc-item').forEach(bindItem);

    addBtn.addEventListener('click', ()=>{
      const first = wrap.querySelector('.svc-item');
      const item  = first.cloneNode(true);
      item.querySelector('.svc-select').selectedIndex = 0;
      item.querySelector('.svc-price').value = first.querySelector('.svc-select').selectedOptions[0].getAttribute('data-price') || 300;
      item.querySelector('.svc-qty').value   = 1;
      wrap.appendChild(item);
      bindItem(item);
      recalc();
    });

    discInput?.addEventListener('input', recalc);
    taxInput?.addEventListener('input', recalc);
    recalc();
  })();
</script>

</body>
</html>
