<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>شاشة الزيارة — كاملة + Spots ديناميك</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f9fc;--surface:#fff;--text:#0f172a;--muted:#64748b;--line:#e2e8f0;--primary:#2563eb;--radius-xl:18px;--radius:12px;--shadow:0 8px 24px rgba(37,99,235,.08);}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f8fafc,#f4f6fa);color:var(--text);font:15.5px/1.7 'Cairo',system-ui}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .topbar{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px) saturate(140%);background:rgba(255,255,255,.9);border-bottom:1px solid var(--line)}
    .topbar-inner{display:flex;justify-content:space-between;align-items:center;padding:12px 20px}
    .brand{display:flex;align-items:center;gap:12px}
    .avatar{width:42px;height:42px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;font-weight:800;box-shadow:0 4px 10px rgba(37,99,235,.25)}
    .actions{display:flex;gap:10px}
    .btn{appearance:none;border:1px solid var(--line);cursor:pointer;border-radius:var(--radius);padding:10px 14px;font-weight:800;background:#fff;color:#0f172a;box-shadow:0 6px 14px rgba(15,23,42,.06);transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(15,23,42,.1)}
    .btn.primary{background:linear-gradient(135deg,#3b82f6,#2563eb);border:0;color:#fff;box-shadow:0 8px 18px rgba(37,99,235,.25)}
    .btn.danger{background:#fee2e2;border-color:#fca5a5}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;padding-bottom:8px}
    .tab-btn{background:#fff;border:1px solid var(--line);color:#334155;padding:10px 16px;border-radius:14px;cursor:pointer;box-shadow:0 6px 14px rgba(15,23,42,.06)}
    .tab-btn[aria-selected="true"]{color:#0f172a;background:#eef4ff;border:1px solid #c7d2fe}
    .tabpanels{padding-top:16px}
    .tabpanel{display:none}
    .tabpanel[aria-hidden="false"]{display:block;animation:fadeIn .35s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius-xl);box-shadow:var(--shadow);overflow:hidden;margin:12px 0}
    .card .head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:linear-gradient(90deg,#f8fafc,#f1f5f9);border-bottom:1px solid var(--line)}
    .card .head h3{margin:0;font-size:1rem;color:var(--primary);position:relative;padding-inline-start:12px}
    .card .head h3::before{content:"";position:absolute;inset-inline-start:0;top:6px;width:6px;height:18px;border-radius:6px;background:linear-gradient(180deg,#60a5fa,#2563eb)}
    .card .body{padding:18px}
    .hint{color:#64748b;font-size:13px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:1080px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-bottom:12px}
    .field{display:flex;flex-direction:column;gap:6px;grid-column:span 6}
    .field.third{grid-column:span 4}
    .field.quarter{grid-column:span 3}
    .field.full{grid-column:1/-1}
    label{color:#0f172a;font-weight:800;font-size:13.5px}
    input,select,textarea{width:100%;padding:12px;border-radius:14px;background:#fff;border:1px solid #d1d9e6;color:#0f172a;outline:none}
    textarea{min-height:96px;resize:vertical}
    .skin-types{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .skin-card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px;border:2px solid #e2e8f0;border-radius:14px;background:#fff;cursor:pointer}
    .skin-card.active{border-color:#2563eb;background:#eff6ff}
    .skin-swatch{width:32px;height:32px;border-radius:999px;border:1px solid #e2e8f0}
    .st1{background:#fdebd4}.st2{background:#f6d6b5}.st3{background:#e6be9a}.st4{background:#c48d62}.st5{background:#9b6946}.st6{background:#5b3c2d}
    .bp-toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
    .bp-toolbar .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;font-size:13px}
    .bp-toolbar .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .bp-toolbar .btn.danger{background:#fee2e2;border-color:#fca5a5}
    .coord-controls{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 12px}
    .coord-group{display:flex;align-items:center;gap:6px}
    .coord-label{font-size:12px;font-weight:800;color:#334155}
    .coord-input{width:78px;padding:4px 6px;border:1px solid #d1d9e6;border-radius:8px;font-size:12px}
    .coord-input[disabled]{background:#f3f4f6;color:#64748b}
    .coord-key{min-width:240px}
    .bodypicker{position:relative;width:100%;border:1px solid var(--line);border-radius:14px;background:#fff;overflow:hidden}
    .bp-canvas{position:relative;width:100%}
    .bp-img{display:block;width:100%;height:auto;user-select:none}
    .bp-spot{position:absolute;transform:translate(-50%,-50%);width:34px;height:34px;border-radius:50%;border:2px solid rgba(37,99,235,.35);background:rgba(37,99,235,.12);display:grid;place-items:center;cursor:grab;transition:transform .15s,box-shadow .15s,background .15s,border-color .15s;touch-action:none}
    .bp-spot::after{content:"";width:14px;height:14px;border-radius:50%;background:#2563eb}
    .bp-spot:hover{transform:translate(-50%,-50%) scale(1.06);box-shadow:0 8px 18px rgba(37,99,235,.18)}
    .bp-spot.selected{background:rgba(37,99,235,.28);border-color:#2563eb}
    .bp-spot[data-name]:hover::before{content:attr(data-name);position:absolute;bottom:100%;left:50%;transform:translate(-50%,-6px);background:#0f172a;color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;white-space:nowrap;box-shadow:0 6px 14px rgba(15,23,42,.2)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #e2e8f0;padding:10px;text-align:right;vertical-align:middle}
    th{color:#334155;background:#f9fafc;font-weight:800}
    .totals{display:grid;gap:8px;border-top:1px dashed var(--line);padding-top:12px;margin-top:8px}
    .totals .line{display:flex;justify-content:space-between}
    .grand{font-size:18px;font-weight:800;color:var(--primary)}
    @media print{.no-print{display:none!important}body{background:#fff}.card{box-shadow:none}}
    .note{font-size:12px;color:#64748b}
    /* Inline styles moved from HTML */
    .brand-title{font-weight:900}
    .brand-sub{color:var(--muted)}
    .bodypicker-title{position:absolute;left:50%;top:10px;transform:translateX(-50%);z-index:10;pointer-events:none;}
    .bodypicker-title span{background:rgba(255,255,255,0.8);padding:6px 14px;border-radius:12px;font-weight:800;color:#2563eb;font-size:18px;}
    .table-wrap{margin-top:8px}
    .advice-block{margin-top:6px}
    .advice-block .table-wrap{margin-top:8px}
    .lab-item{border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px;background:#fff}
    .svc-item{border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px;background:#fff}
    .svc-select{width:100%}
    .svc-price{width:100%}
    .svc-qty{width:100%}
    .svc-remove{width:100%}
    .advice-input{width:100%}
    .advice-presets{width:auto}
    .freq-hint{margin-top:4px}
    .actions-footer{display:flex;justify-content:flex-end;margin-top:16px}
    .row.mb-12{margin-bottom:12px}
    .row.mt-12{margin-top:12px}
    .row.mt-14{margin-top:14px}
    .row.mt-8{margin-top:8px}
    .row.mt-6{margin-top:6px}
    .row.mt-10{margin-top:10px}
    .row.mt-16{margin-top:16px}
    .row.mb-8{margin-bottom:8px}
    .row.mb-6{margin-bottom:6px}
    .row.mb-10{margin-bottom:10px}
    .row.mb-16{margin-bottom:16px}
    .row.mt-0{margin-top:0}
    .row.mb-0{margin-bottom:0}
    .row.mt-24{margin-top:24px}
    .row.mb-24{margin-bottom:24px}
    .row.mt-32{margin-top:32px}
    .row.mb-32{margin-bottom:32px}
    .row.mt-4{margin-top:4px}
    .row.mb-4{margin-bottom:4px}
    .row.mt-2{margin-top:2px}
    .row.mb-2{margin-bottom:2px}
    .row.mt-20{margin-top:20px}
    .row.mb-20{margin-bottom:20px}
    .row.mt-18{margin-top:18px}
    .row.mb-18{margin-bottom:18px}
    .row.mt-28{margin-top:28px}
    .row.mb-28{margin-bottom:28px}
    .row.mt-36{margin-top:36px}
    .row.mb-36{margin-bottom:36px}
    .row.mt-40{margin-top:40px}
    .row.mb-40{margin-bottom:40px}
    .row.mt-48{margin-top:48px}
    .row.mb-48{margin-bottom:48px}
    .row.mt-56{margin-top:56px}
    .row.mb-56{margin-bottom:56px}
    .row.mt-64{margin-top:64px}
    .row.mb-64{margin-bottom:64px}
    .row.mt-72{margin-top:72px}
    .row.mb-72{margin-bottom:72px}
    .row.mt-80{margin-top:80px}
    .row.mb-80{margin-bottom:80px}
    .row.mt-96{margin-top:96px}
    .row.mb-96{margin-bottom:96px}
    .row.mt-100{margin-top:100px}
    .row.mb-100{margin-bottom:100px}
    .row.mt-120{margin-top:120px}
    .row.mb-120{margin-bottom:120px}
    .row.mt-160{margin-top:160px}
    .row.mb-160{margin-bottom:160px}
    .row.mt-200{margin-top:200px}
    .row.mb-200{margin-bottom:200px}
    .row.mt-240{margin-top:240px}
    .row.mb-240{margin-bottom:240px}
    .row.mt-320{margin-top:320px}
    .row.mb-320{margin-bottom:320px}
    .row.mt-400{margin-top:400px}
    .row.mb-400{margin-bottom:400px}
    .row.mt-480{margin-top:480px}
    .row.mb-480{margin-bottom:480px}
    .row.mt-560{margin-top:560px}
    .row.mb-560{margin-bottom:560px}
    .row.mt-640{margin-top:640px}
    .row.mb-640{margin-bottom:640px}
    .row.mt-720{margin-top:720px}
    .row.mb-720{margin-bottom:720px}
    .row.mt-800{margin-top:800px}
    .row.mb-800{margin-bottom:800px}
    .row.mt-960{margin-top:960px}
    .row.mb-960{margin-bottom:960px}
    .row.mt-1000{margin-top:1000px}
    .row.mb-1000{margin-bottom:1000px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner container">
      <div class="brand"><div class="avatar">د</div><div><div style="font-weight:900">شاشة الزيارة — دكتور جلدية</div><small style="color:var(--muted)">المريض: فاطمة حسن • اليوم 14:30 • د. أحمد</small></div></div>
      <div class="actions no-print">
        <button class="btn">حفظ مسودة</button>
        <button class="btn primary">حفظ الزيارة</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Tabs -->
    <div class="tabs" role="tablist" aria-label="Visit Tabs">
      <button class="tab-btn" role="tab" id="tab-basic"   aria-controls="panel-basic"   aria-selected="true">البيانات الأساسية</button>
      <button class="tab-btn" role="tab" id="tab-dx"      aria-controls="panel-dx"      aria-selected="false">الكشف</button>
      <button class="tab-btn" role="tab" id="tab-rxadv"   aria-controls="panel-rxadv"   aria-selected="false">الروشتة والإرشادات</button>
      <button class="tab-btn" role="tab" id="tab-labs"    aria-controls="panel-labs"    aria-selected="false">التحاليل والملفات</button>
      <button class="tab-btn" role="tab" id="tab-photos"  aria-controls="panel-photos"  aria-selected="false">صور الحالة</button>
      <button class="tab-btn" role="tab" id="tab-billing" aria-controls="panel-billing" aria-selected="false">الخدمات والفوترة</button>
    </div>

    <div class="tabpanels">
      <!-- البيانات الأساسية -->
      <section id="panel-basic" class="tabpanel" role="tabpanel" aria-labelledby="tab-basic" aria-hidden="false">
        <div class="grid">
          <div class="card">
            <div class="head"><h3>🧑 البيانات الأساسية</h3><span class="hint">ملف #P-10234</span></div>
            <div class="body">
              <div class="row">
                <div class="field third"><label>الاسم</label><input value="فاطمة حسن"></div>
                <div class="field quarter"><label>العمر — سنوات</label><input type="number" min="0" max="150" value="28"></div>
                <div class="field quarter"><label>العمر — شهور</label><input type="number" min="0" max="11" value="0"></div>
                <div class="field quarter"><label>النوع</label><select><option>أنثى</option><option>ذكر</option></select></div>
                <div class="field quarter"><label>الحالة الاجتماعية</label><select><option>أعزب/عزباء</option><option>متزوج/ة</option><option>أخرى</option></select></div>
                <div class="field third"><label>المهنة</label><input placeholder="مثال: مُدرّسة"></div>
                <div class="field third"><label>العنوان</label><input placeholder="القاهرة، المهندسين…"></div>
                <div class="field third"><label>رقم التليفون</label><input type="tel" placeholder="01xxxxxxxxx"></div>
                <div class="field full"><label>ملاحظات أخرى</label><input placeholder="أي ملاحظات إضافية…"></div>
              </div>
            </div>
          </div>

          <aside class="card">
            <div class="head"><h3>⚕️ التاريخ المرضي</h3></div>
            <div class="body">
              <div class="row">
                <div class="field quarter"><label>سكر</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>ضغط</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>حساسية أدوية</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>حمل</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field quarter"><label>رضاعة</label><select><option>لا</option><option>نعم</option></select></div>
                <div class="field full"><label>أمراض أخرى</label><input placeholder="مثال: ربو، قلب…"></div>
                <div class="field full"><label>ملاحظات أخرى</label><input placeholder="تفاصيل إضافية…"></div>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- الكشف -->
      <section id="panel-dx" class="tabpanel" role="tabpanel" aria-labelledby="tab-dx" aria-hidden="true">
        <div class="card">
          <div class="head"><h3>🩺 الكشف</h3></div>
          <div class="body">
            <div class="row">
              <div class="field full">
                <label>نوع البشرة (Fitzpatrick)</label>
                <div class="skin-types" id="skinTypes">
                  <div class="skin-card" data-value="I"><div class="skin-swatch st1"></div><div>I</div></div>
                  <div class="skin-card" data-value="II"><div class="skin-swatch st2"></div><div>II</div></div>
                  <div class="skin-card" data-value="III"><div class="skin-swatch st3"></div><div>III</div></div>
                  <div class="skin-card" data-value="IV"><div class="skin-swatch st4"></div><div>IV</div></div>
                  <div class="skin-card" data-value="V"><div class="skin-swatch st5"></div><div>V</div></div>
                  <div class="skin-card" data-value="VI"><div class="skin-swatch st6"></div><div>VI</div></div>
                </div>
                <input type="hidden" id="skinTypeInput" name="skin_type">
              </div>
              <div class="field third"><label>شكوى رئيسية</label><input placeholder="حب شباب — حبوب تحت الجلد"></div>
              <div class="field third"><label>شدة الأعراض</label>
                <select><option>1 — بسيط</option><option>2 — متوسط</option><option>3 — شديد</option><option>4 — عنيف جدًا</option></select>
              </div>
              <div class="field third"><label>المدة</label>
                <select><option>أقل من شهر</option><option>1–3 شهور</option><option>3–6 شهور</option><option>6–12 شهر</option><option>أكثر من سنة</option></select>
              </div>
              <div class="field third"><label>الصورة المرضية (Clinical picture)</label><textarea placeholder="Clinical picture — Grade 2"></textarea></div>

            </div>

            <!-- الأدوات فوق الصورة -->
            <div class="bp-toolbar">
              <button type="button" class="btn primary" id="addByClickBtn"  style="display:none">وضع الإضافة بالنقر: مفعل</button>
              <button type="button" class="btn" id="addNewBtn"  style="display:none">+ إضافة نقطة وسط</button>
              <button type="button" class="btn danger" id="deleteBtn">حذف المحددة</button>
              <button type="button" class="btn danger" id="deleteAllBtn">حذف الكل</button>

            </div>

            <div class="coord-controls">
              <div class="coord-group" style="display:none"><span class="coord-label">X (%)</span><input class="coord-input"   type="number" id="coordX" min="0" max="100" step="0.1" value="50" disabled></div>
              <div class="coord-group" style="display:none"><span class="coord-label">Y (%)</span><input class="coord-input"   type="number" id="coordY" min="0" max="100" step="0.1" value="50" disabled></div>
              <div class="coord-group"><span class="coord-label">الاسم</span><input class="coord-input coord-key" type="text" id="coordName" placeholder="مثال: الوجه الأيسر"></div>
              <div class="coord-group"><span class="coord-label">الوصف</span><input class="coord-input coord-key" type="text" id="coordKey" placeholder="مثال: رأس علوي امامي"></div>
              <button class="btn" id="updateSpot">تحديث الموضع</button>
            </div>

            <!-- BODY PICKER -->
            <!--اضافة تيكست فوق منتصف الصورة  -->
            <div class="bodypicker" id="BodyPicker" aria-label="خريطة جسم" style="position: relative;">

                <!-- العنوان -->
                <div style="position: absolute; left: 50%; top: 10px; transform: translateX(-50%); z-index: 10; pointer-events: none;">
                    <span style="background: rgba(255,255,255,0.8); padding: 6px 14px; border-radius: 12px; font-weight: 800; color: #2563eb; font-size: 18px;">
                    اماكن الاصابة (Distribution)
                    </span>
                </div>
                <div class="bp-canvas" id="bpCanvas">
                    <img id="bpImage" class="bp-img" alt="Body Front" draggable="false"
                     src="https://api.cefour.com/storage/image/anatomy_68bc89752e694.png">
                <!-- spots injected here -->
              </div>
            </div>
            <input type="hidden" id="locationsInput" name="locations">

            <!-- باقي حقول الكشف -->
            <div class="row" style="margin-top:12px; margin-bottom: 12px;">
                <div class="field full">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <label style="margin:0">جدول التشخيص</label>
                            <button id="addDxRow" class="btn primary">+ إضافة تشخيص</button>
                            </div>
                            <div class="table-wrap" style="margin-top:8px">
                            <table>
                                <thead>
                                <tr>
                                    <th>التشخيص</th>
                                    <th>ملاحظات</th>
                                    <th>حذف</th>
                                </tr>
                                </thead>
                                <tbody id="dxBody">
                                <tr>
                                    <td><input placeholder="مثال: Acne vulgaris — Grade 2"></td>
                                    <td><input placeholder="ملاحظات التشخيص"></td>
                                    <td><button class="btn danger dx-remove">✕</button></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                </div>
              <!-- <div class="field third"><label>التشخيص</label><textarea placeholder="Acne vulgaris — Grade 2"></textarea></div> -->
              <!-- <div class="field third"><label>ملاحظات التشخيص</label><textarea placeholder="PIH، ندبات سطحية…"></textarea></div> -->
              <div class="field third"><label>موعد المتابعة</label><input type="date"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- الروشتة والإرشادات -->
      <section id="panel-rxadv" class="tabpanel" role="tabpanel" aria-labelledby="tab-rxadv" aria-hidden="true">
        <div class="card">
          <div class="head"><h3>💊 الروشتة & 💡 الإرشادات</h3></div>
          <div class="body">
            <!-- لا قوالب روشتة هنا حسب طلبك -->
            <div class="row">
              <div class="field full">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <label style="margin:0">جدول الأدوية</label>
                  <button id="addMedRow" class="btn primary">+ إضافة دواء</button>
                </div>
                <div class="note">معلومة: لو اخترت “كل X ساعة” بقيمة ≥ 24 (مثلاً 48)، هيُفهم كجرعة كل 48 ساعة.</div>
                <div class="table-wrap" style="margin-top:8px">
                  <table style="direction:ltr">
                    <thead>
                      <tr>
                        <th style="text-align:left">الدواء</th>
                        <th style="text-align:left">التركيز</th>
                        <th style="text-align:left">التكرار</th>
                        <th style="text-align:left">المدّة (أيام)</th>
                        <th style="text-align:left">تعليمات</th>
                        <th style="text-align:left">حذف</th>
                      </tr>
                    </thead>
                    <tbody id="medsBody">
                      <tr>
                        <td><input placeholder="اسم الدواء"></td>
                        <td><input placeholder="تركيز"></td>
                        <td>
                          <div style="display:flex;gap:8px;align-items:center">
                            <select class="per-day" title="مرات/اليوم"></select><span>مرة/يوم</span>
                            <select class="every-hours" title="كل كام ساعة"></select><span>ساعات</span>
                          </div>
                          <div class="note freq-hint"></div>
                        </td>
                        <td><input type="number" value="7" min="1"></td>
                        <td><input placeholder="تعليمات"></td>
                        <td><button class="btn danger med-remove">✕</button></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="row" style="margin-top:14px">
              <div class="field full">
                <label style="display:flex;align-items:center;gap:8px">
                  <input id="adviceActivate" type="checkbox"> تفعيل الإرشادات
                </label>
              </div>
            </div>

            <div id="adviceBlock" style="display:none">
              <div class="row">
                <div class="field full" style="margin-top:6px">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <label style="margin:0">الإرشادات</label>
                    <button id="addAdviceRow" class="btn">+ إضافة إرشاد</button>
                  </div>
                  <table>
                    <thead><tr><th>التعليمات</th><th>حذف</th></tr></thead>
                    <tbody id="adviceBody">
                      <tr>
                        <td>
                          <div style="display:flex;gap:6px;align-items:center">
                            <input class="advice-input" placeholder="تعليمات">
                            <select class="advice-presets" title="قوالب جاهزة">
                              <option value="">— من القوالب —</option>
                              <option>ابتعد عن الشمس</option>
                              <option>SPF 50+ يوميًا</option>
                              <option>مرطّب صباحًا ومساءً</option>
                              <option>غسول لطيف</option>
                              <option>اختبار حساسية موضعي أولًا</option>
                              <option>تجنّب محيط العين</option>
                            </select>
                          </div>
                        </td>
                        <td><button class="btn danger advice-remove">✕</button></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- التحاليل والملفات -->
      <section id="panel-labs" class="tabpanel" role="tabpanel" aria-labelledby="tab-labs" aria-hidden="true">
        <div class="grid">
          <div class="card">
            <div class="head"><h3>🧪 التحاليل</h3></div>
            <div class="body">
              <div class="hint">اسحب ملف نتيجة (PDF/صورة) أو اضغط للاختيار</div>
              <div id="labRepeater" style="margin-top:10px">
                <div class="lab-item" style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px;background:#fff">
                  <div class="row">
                    <div class="field third"><label>اسم التحليل</label><input placeholder="CBC / LFTs / …"></div>
                    <div class="field third"><label>ملاحظات</label><input placeholder="صيام، وقت، إلخ"></div>
                    <div class="field third"><label>رفع النتيجة</label><input type="file"></div>
                    <div class="field third"><label>بيان المعمل</label><input value="المعمل : القصر العيني"></div>
                    <div class="field quarter"><label>&nbsp;</label><button class="btn lab-remove" style="width:100%">حذف</button></div>
                  </div>
                </div>
              </div>
              <button id="addLab" class="btn" style="margin-top:8px">+ إضافة تحليل</button>
            </div>
          </div>

          <aside class="card">
            <div class="head"><h3>📎 ملفات محفوظة</h3></div>
            <div class="body">
              <table>
                <thead><tr><th>الملف</th><th>النوع</th><th>التاريخ</th><th>إجراء</th></tr></thead>
                <tbody>
                  <tr><td>CBC-Result-2025-09-02.pdf</td><td>PDF</td><td>02-09-2025</td><td><button class="btn">عرض</button></td></tr>
                  <tr><td>lesion-closeup-1.jpg</td><td>صورة</td><td>02-09-2025</td><td><button class="btn">عرض</button></td></tr>
                </tbody>
              </table>
            </div>
          </aside>
        </div>
      </section>

      <!-- صور الحالة -->
      <section id="panel-photos" class="tabpanel" role="tabpanel" aria-labelledby="tab-photos" aria-hidden="true">
        <div class="card">
          <div class="head"><h3>📸 صور الحالة</h3></div>
          <div class="body">
            <div class="hint" style="margin-bottom:8px">الرجاء الحصول على موافقة تصوير واضحة من المريض.</div>
            <div class="row">
              <div class="field full"><label>ملاحظات على الصور</label><input placeholder="مسافة 50سم، إضاءة موحّدة، زاوية أمامية/جانبية"></div>
              <div class="field third"><div class="btn" style="width:100%">إضافة صورة</div></div>
              <div class="field third"><div class="btn" style="width:100%">إضافة صورة</div></div>
              <div class="field third"><div class="btn" style="width:100%">إضافة صورة</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- الفوترة -->
      <section id="panel-billing" class="tabpanel" role="tabpanel" aria-labelledby="tab-billing" aria-hidden="true">
        <div class="grid">
          <div class="card">
            <div class="head"><h3>💳 الخدمات والإجراءات</h3></div>
            <div class="body">
              <div class="hint">يمكن تعديل السعر يدويًا لكل خدمة.</div>
              <div id="svcRepeater">
                <div class="svc-item" style="border:1px solid var(--line);border-radius:14px;padding:12px;margin-top:8px;background:#fff">
                  <div class="row">
                    <div class="field third"><label>الخدمة</label>
                      <select class="svc-select">
                        <option value="consult" data-price="300">كشف جلدية</option>
                        <option value="laser_small" data-price="500">جلسة ليزر (منطقة صغيرة)</option>
                        <option value="peel_light" data-price="400">تقشير كيميائي خفيف</option>
                        <option value="dermapen" data-price="600">Dermapen</option>
                        <option value="other" data-price="0">خدمة أخرى…</option>
                      </select>
                    </div>
                    <div class="field quarter"><label>السعر (جنيه)</label><input class="svc-price" type="number" value="300" min="0" step="1"></div>
                    <div class="field quarter"><label>الكمية</label><input class="svc-qty" type="number" value="1" min="1" step="1"></div>
                    <div class="field quarter"><label>إجمالي البند</label><div class="hint"><strong class="line-total">EGP 300.00</strong></div></div>
                    <div class="field quarter"><label>&nbsp;</label><button class="btn svc-remove" style="width:100%">حذف</button></div>
                  </div>
                </div>
              </div>
              <button id="addSvc" class="btn" style="margin-top:8px">+ إضافة خدمة</button>
            </div>
          </div>

          <aside class="card">
            <div class="head"><h3>🧾 الملخص المالي</h3></div>
            <div class="body">
              <div class="row">
                <div class="field third"><label>طريقة الدفع</label><select><option>نقدي</option><option>تحويل</option></select></div>
                <div class="field third"><label>سبب الخصم</label><input id="discReason" placeholder="عرض/كوبون/ولاء"></div>
                <div class="field third"><label>قيمة الخصم</label><input id="discInput" type="number" value="0" min="0" step="1"></div>
              </div>
              <div class="totals">
                <div class="line"><span>المجموع</span><strong id="subtotalVal">EGP 0.00</strong></div>
                <div class="line"><span>خصم</span><strong id="discountVal">EGP 0.00</strong></div>
                <div class="line grand"><span>الإجمالي</span><span id="totalVal">EGP 0.00</span></div>
              </div>
              <div class="row" style="margin-top:12px">
                <div class="field third"><button class="btn">إصدار فاتورة</button></div>
                <div class="field third"><button class="btn primary">تحصيل الآن</button></div>
              </div>
            </div>
          </aside>
        </div>
      </section>
    </div>

    <div class="actions" style="display:flex;justify-content:flex-end;margin-top:16px">
      <button class="btn">حفظ مسودة</button>
      <button class="btn primary">حفظ الزيارة</button>
    </div>
  </main>

<script>
  // ===== Tabs =====
    // ===== Diagnosis table =====
  (function(){
    const dxBody=document.getElementById('dxBody');
    const addBtn=document.getElementById('addDxRow');

    function bindRow(tr){
      tr.querySelector('.dx-remove').addEventListener('click',()=>{
        if(dxBody.children.length>1) tr.remove();
      });
    }
    dxBody.querySelectorAll('tr').forEach(bindRow);

    addBtn.addEventListener('click',()=>{
      const tr=dxBody.querySelector('tr').cloneNode(true);
      tr.querySelector('input').value='';
      bindRow(tr);
      dxBody.appendChild(tr);
    });
  })();

  const tabs = document.querySelectorAll('[role="tab"]');
  const panels = document.querySelectorAll('[role="tabpanel"]');
  function activateTab(tab){
    tabs.forEach(t=> t.setAttribute('aria-selected','false'));
    panels.forEach(p=> p.setAttribute('aria-hidden','true'));
    tab.setAttribute('aria-selected','true');
    document.getElementById(tab.getAttribute('aria-controls')).setAttribute('aria-hidden','false');
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> activateTab(t)));

  // ===== Skin types selector =====
  (function(){
    const wrap = document.getElementById('skinTypes');
    const input = document.getElementById('skinTypeInput');
    if(!wrap) return;
    wrap.querySelectorAll('.skin-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        wrap.querySelectorAll('.skin-card').forEach(c=>c.classList.remove('active'));
        card.classList.add('active');
        input.value = card.dataset.value;
      });
    });
  })();

  // ===== BodyPicker — add-by-click default, tools above, X/Y disabled + touch =====
  (function(){
    const PATIENT_ID='P-10234', VISIT_ID='V-2025-09-06-1430';
    const STORAGE_KEY=`derma_spots:${PATIENT_ID}:${VISIT_ID}`;

    const canvas  = document.getElementById('bpCanvas');
    const img     = document.getElementById('bpImage');
    const hidden  = document.getElementById('locationsInput');

    const addByClickBtn = document.getElementById('addByClickBtn');
    const addNewBtn     = document.getElementById('addNewBtn');
    const deleteBtn     = document.getElementById('deleteBtn');
    const coordX   = document.getElementById('coordX');
    const coordY   = document.getElementById('coordY');
    const coordKey = document.getElementById('coordKey');
    const coordName= document.getElementById('coordName');
    const updateBtn= document.getElementById('updateSpot');

    let spots=[];
    try{ spots = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch{ spots=[]; }
    if(!Array.isArray(spots)) spots=[];
    let selected=null;
    let addByClick=true;
    let dragging=false;

    function persist(){
      hidden.value = JSON.stringify(spots);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(spots));
    }
    function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
    function uid(){return 's_'+Math.random().toString(36).slice(2,9)}
    function pctFromClient(clientX, clientY){
      const r = img.getBoundingClientRect();
      if(clientX<r.left||clientX>r.right||clientY<r.top||clientY>r.bottom) return null;
      const x = ((clientX - r.left)/r.width)*100;
      const y = ((clientY - r.top)/r.height)*100;
      return {x: clamp(+x.toFixed(1),0,100), y: clamp(+y.toFixed(1),0,100)};
    }
    function updateXYInputs(sp){
      coordX.value = sp.x; coordY.value = sp.y;
      coordKey.value = sp.key || ''; coordName.value = sp.name || '';
    }
    function select(el){
      canvas.querySelectorAll('.bp-spot').forEach(s=>s.classList.remove('selected'));
      el.classList.add('selected'); selected=el;
      const sp = spots.find(x=>x.id===el.dataset.id); if(sp) updateXYInputs(sp);
    }
    function onDragStart(el, startEvent){
      dragging=false;
      const move = (ev) => {
        dragging=true;
        const p = ('touches' in ev)? pctFromClient(ev.touches[0].clientX, ev.touches[0].clientY)
                                   : pctFromClient(ev.clientX, ev.clientY);
        if(!p) return;
        el.style.left=p.x+'%'; el.style.top=p.y+'%';
        const sp=spots.find(x=>x.id===el.dataset.id);
        if(sp){ sp.x=p.x; sp.y=p.y; updateXYInputs(sp); persist(); }
      };
      const up = () => {
        window.removeEventListener('mousemove', move);
        window.removeEventListener('mouseup', up);
        window.removeEventListener('touchmove', move);
        window.removeEventListener('touchend', up);
        setTimeout(()=> dragging=false, 0);
      };
      window.addEventListener('mousemove', move, {passive:true});
      window.addEventListener('mouseup', up, {passive:true});
      window.addEventListener('touchmove', move, {passive:true});
      window.addEventListener('touchend', up, {passive:true});
    }

    function render(){
      canvas.querySelectorAll('.bp-spot').forEach(n=>n.remove());
      const frag=document.createDocumentFragment();
      spots.forEach((s,idx)=>{
        const b=document.createElement('button');
        b.type='button'; b.className='bp-spot'; b.dataset.id=s.id; b.dataset.key=s.key||''; b.dataset.name=s.name||'';
        b.title = s.name || s.key || '';
        b.style.left=s.x+'%'; b.style.top=s.y+'%';

        b.addEventListener('click',(e)=>{ if(dragging) return; e.stopPropagation(); select(b); });
        b.addEventListener('mousedown',(e)=>{e.preventDefault(); onDragStart(b, e);});
        b.addEventListener('touchstart',(e)=>{onDragStart(b, e);});

        frag.appendChild(b);
      });
      canvas.appendChild(frag);
      persist();
    }
    function addSpot(x=50,y=50,key=''){
      const id=uid(); const s={id, key, name:'', x, y}; spots.push(s); render();
      const el=canvas.querySelector(`.bp-spot[data-id="${id}"]`); if(el) select(el);
    }
    function setAddByClick(on){
      addByClick = !!on;
      addByClickBtn.classList.toggle('primary', addByClick);
      addByClickBtn.textContent = addByClick ? 'وضع الإضافة بالنقر: مفعل' : 'تفعيل الإضافة بالنقر';
    }
    setAddByClick(true);

    addNewBtn.addEventListener('click', ()=> addSpot());
    addByClickBtn.addEventListener('click', ()=> setAddByClick(!addByClick));

    function handleAdd(e){
      if(!addByClick) return;
      const p= ('clientX' in e)? pctFromClient(e.clientX, e.clientY)
                                : pctFromClient(e.touches?.[0]?.clientX, e.touches?.[0]?.clientY);
      if(!p) return; addSpot(p.x, p.y);
    }
    img.addEventListener('click', handleAdd);
    canvas.addEventListener('click', e=>{ if(e.target===canvas) handleAdd(e); });

    updateBtn.addEventListener('click', ()=>{
      if(!selected) return;
      const sp=spots.find(x=>x.id===selected.dataset.id); if(!sp) return;
      sp.key=(coordKey.value||'').trim(); sp.name=(coordName.value||'').trim();
      selected.dataset.name=sp.name||''; selected.title=sp.name||sp.key||''; persist();
    });
    function deleteSelected(){
      if(!selected) return;
      spots = spots.filter(s=>s.id!==selected.dataset.id); selected=null; render();
    }
    function deleteAll(){
      spots = [];
      selected=null;
      render();
    }
  document.getElementById('deleteAllBtn').addEventListener('click', deleteAll);
    deleteBtn.addEventListener('click', deleteSelected);
    document.addEventListener('keydown', e=>{ if(e.key==='Delete') deleteSelected(); });

    img.addEventListener('load', render); render();
  })();

  // ===== Meds (no templates) — per-day + every-hours (1..72) =====
  (function(){
    const medsBody=document.getElementById('medsBody');
    const addBtn=document.getElementById('addMedRow');

    function buildOptions(sel,start,end){
      sel.innerHTML=''; for(let i=start;i<=end;i++){ sel.add(new Option(i,i)); }
    }
    function updateFreqHint(tr){
      const perDay=tr.querySelector('.per-day');
      const every =tr.querySelector('.every-hours');
      const hint  =tr.querySelector('.freq-hint');
      const d = parseInt(perDay.value||0,10);
      const h = parseInt(every.value||0,10);
      let text='';
      if(h>=24){ text = `كل ${h} ساعة`; }
      else if(d>0 && h>0){ text = `${d} مرة/اليوم — كل ${h} ساعة تقريبًا`; }
      else if(d>0){ text = `${d} مرة/اليوم`; }
      else if(h>0){ text = `كل ${h} ساعة`; }
      hint.textContent = text;
    }
    function bindRow(tr){
      const perDay=tr.querySelector('.per-day');
      const every =tr.querySelector('.every-hours');
      buildOptions(perDay,1,20);
      buildOptions(every,1,72); // لدعم 48 ساعة وغيرها
      perDay.value = perDay.value || '1';
      every.value  = every.value  || '12';
      perDay.addEventListener('change', ()=> updateFreqHint(tr));
      every.addEventListener('change', ()=> updateFreqHint(tr));
      tr.querySelector('.med-remove').addEventListener('click',()=>{if(medsBody.children.length>1) tr.remove();});
      updateFreqHint(tr);
    }
    medsBody.querySelectorAll('tr').forEach(bindRow);

    addBtn.addEventListener('click',()=>{
      const tr=medsBody.querySelector('tr').cloneNode(true);
      tr.querySelectorAll('input').forEach(inp=>{
        if(inp.type==='number') { inp.value = inp.getAttribute('min') || '1'; }
        else { inp.value=''; }
      });
      bindRow(tr);
      medsBody.appendChild(tr);
    });
  })();

  // ===== Advice =====
  (function(){
    const toggle=document.getElementById('adviceActivate');
    const block=document.getElementById('adviceBlock');
    const body=document.getElementById('adviceBody');
    const addBtn=document.getElementById('addAdviceRow');

    function bindRow(tr){
      const input=tr.querySelector('.advice-input');
      const presets=tr.querySelector('.advice-presets');
      presets.addEventListener('change',()=>{ if(presets.value) input.value=presets.value; });
      tr.querySelector('.advice-remove').addEventListener('click',()=>{ if(body.children.length>1) tr.remove(); });
    }
    body.querySelectorAll('tr').forEach(bindRow);

    addBtn.addEventListener('click',()=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><div style="display:flex;gap:6px;align-items:center"><input class="advice-input" placeholder="تعليمات"><select class="advice-presets"><option value="">— من القوالب —</option><option>ابتعد عن الشمس</option><option>SPF 50+ يوميًا</option><option>مرطّب صباحًا ومساءً</option><option>غسول لطيف</option><option>اختبار حساسية موضعي أولًا</option><option>تجنّب محيط العين</option></select></div></td><td><button class="btn danger advice-remove">✕</button></td>`;
      bindRow(tr); body.appendChild(tr);
    });
    toggle.addEventListener('change',()=>{ block.style.display = toggle.checked ? 'block':'none'; });
  })();

  // ===== Labs repeater =====
  (function(){
    const wrap = document.getElementById('labRepeater');
    const addBtn = document.getElementById('addLab');
    if(!wrap || !addBtn) return;
    addBtn.addEventListener('click', ()=>{
      const first = wrap.querySelector('.lab-item');
      const item = first.cloneNode(true);
      item.querySelectorAll('input').forEach(inp=>{
        if(inp.type==='file'){ try{inp.value=null;}catch(e){} }
        else{
          if(inp.previousElementSibling?.tagName==='LABEL'
             && inp.previousElementSibling.textContent.includes('بيان المعمل')){
            inp.value='المعمل : القصر العيني';
          }else{
            inp.value='';
          }
        }
      });
      wrap.appendChild(item);
    });
    wrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lab-remove'); if(!btn) return;
      const items = wrap.querySelectorAll('.lab-item');
      if(items.length>1){ btn.closest('.lab-item').remove(); }
    });
  })();

  // ===== Services repeater + totals (billing) =====
  (function(){
    const wrap = document.getElementById('svcRepeater');
    const addBtn = document.getElementById('addSvc');
    const subtotalEl = document.getElementById('subtotalVal');
    const discountEl = document.getElementById('discountVal');
    const totalEl = document.getElementById('totalVal');
    const discInput = document.getElementById('discInput');
    const fmt = n => 'EGP ' + (isFinite(n)? Number(n).toFixed(2) : '0.00');

    function recalc(){
      let subtotal = 0;
      wrap.querySelectorAll('.svc-item').forEach(it=>{
        const price = parseFloat(it.querySelector('.svc-price')?.value||0);
        const qty   = parseInt(it.querySelector('.svc-qty')?.value||1);
        const line  = (isFinite(price)&&isFinite(qty)) ? price*qty : 0;
        subtotal += line;
        const lineEl = it.querySelector('.line-total');
        if(lineEl) lineEl.textContent = fmt(line);
      });
      const discount = parseFloat(discInput?.value||0);
      subtotalEl.textContent = fmt(subtotal);
      discountEl.textContent = fmt(discount);
      totalEl.textContent    = fmt(subtotal - discount);
    }
    function bindItem(it){
      const sel  = it.querySelector('.svc-select');
      const priceInput = it.querySelector('.svc-price');
      const qtyInput   = it.querySelector('.svc-qty');
      sel.addEventListener('change', ()=>{
        const p = parseFloat(sel.selectedOptions[0].dataset.price||0);
        if(priceInput) priceInput.value = isFinite(p)? p : 0;
        recalc();
      });
      priceInput?.addEventListener('input', recalc);
      qtyInput?.addEventListener('input', recalc);
      it.querySelector('.svc-remove')?.addEventListener('click', ()=>{
        const items = wrap.querySelectorAll('.svc-item');
        if(items.length>1){ it.remove(); recalc(); }
      });
    }
    wrap.querySelectorAll('.svc-item').forEach(bindItem);

    addBtn.addEventListener('click', ()=>{
      const first = wrap.querySelector('.svc-item');
      const item  = first.cloneNode(true);
      const sel   = item.querySelector('.svc-select');
      sel.selectedIndex = 0;
      item.querySelector('.svc-price').value = sel.selectedOptions[0].dataset.price || 300;
      item.querySelector('.svc-qty').value   = 1;
      wrap.appendChild(item);
      bindItem(item);
      recalc();
    });

    discInput?.addEventListener('input', recalc);
    recalc();
  })();
</script>
</body>
</html>
